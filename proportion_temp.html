<!DOCTYPE html>
<!-- <html lang="en">
<head>
  <meta charset="utf-8">
  <title>d3 | simple square grid</title> 
  <meta name="author" content="Sundar Singh | eesur.com">
  
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" charset="utf-8"></script>

</head>

<header>
  <h4 id="grid-ref">roll-over grid</h4>
</header>

<section id='grid'></section>


<script src="js/vendor/jquery-3.2.1.min.js" charset="utf-8"></script>
<script src="js/proportion.js" charset="utf-8"></script>
<script src="js/global.js" charset="utf-8"></script>


</body>
</html> -->

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>grid canvas</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
 	<script src="http://d3js.org/d3.v4.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<style type="text/css">
		
		body {
			font-family: 'Open Sans', sans-serif;

		}
		
		canvas {
			border:  1px dotted #ccc;
		}

		#container {
			width: 1200px;
			height: 600px;

		}
		
		.explain, #select {
			display: inline-block;
			font-size: 0.75em;
			margin-bottom: 1em;
		}


		.alert {
			color: tomato;
		}

	</style>
</head>
<body>

	<h3>Coloured grids on canvas</h3>
	<!-- <input type="text" id="textinput" value="10000"> -->
	<!-- <div class="explain" id="text-explain">...takes numbers between 1 and 10k &nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;&nbsp;</div>
	<div id="select"></div>
	<div class="explain">...from <a href="https://github.com/d3/d3-scale-chromatic">d3-scale-chromatic</a></div> -->
	<div id="container"></div>
	

	<script>

		// var log = console.log.bind(console);
		// var dir = console.dir.bind(console);
		// var replace = function(string) { return string.replace(/[^a-z0-9]/gi,""); };


		// === Set up canvas === //

		// var width = 5000,
		// 	height = 5000;

		var data;
		var value = 50000;
		// var colours = ['interpolateBrBG', 'interpolatePRGn', 'interpolatePiYG', 'interpolatePuOr', 'interpolateRdBu', 'interpolateRdGy', 'interpolateRdYlBu', 'interpolateRdYlGn', 'interpolateSpectral', 'interpolateBlues', 'interpolateGreens', 'interpolateGreys', 'interpolateOranges', 'interpolatePurples', 'interpolateReds', 'interpolateBuGn', 'interpolateBuPu', 'interpolateGnBu', 'interpolateOrRd', 'interpolatePuBuGn', 'interpolatePuBu', 'interpolatePuRd', 'interpolateRdPu', 'interpolateYlGnBu', 'interpolateYlGn', 'interpolateYlOrBr', 'interpolateYlOrRd']
		// var numberScale;
		// var colourId = 8;

		var gridDiv = document.getElementById("container");
		var width = gridDiv.clientWidth;
    	var height = gridDiv.clientHeight;
    	// console.log('w: ' + width);
    	// console.log('h: ' + height);
		var canvas = d3.select('#container')
			.append('canvas')
			.attr('width', width)
			.attr('height', height);

		var context = canvas.node().getContext('2d');


		// === Load and prepare the data === //


		data = d3.range(value);
	  	makeChart(data);

		function makeChart(data) {

			// === Bind data to custom elements === //

			var customBase = document.createElement('custom');
			var custom = d3.select(customBase); // this is our svg replacement


			// settings for a grid with 40 cells in a row and 2x5 cells in a group
			// var groupSpacing = 0;
			var cellSpacing = 1;
			// var offsetTop = height / 5;
			// var cellSize = (width - 20 * cellSpacing - 3 * groupSpacing) / 20;
			// var cellSize = Math.floor((width - 11 * groupSpacing) / 100) - cellSpacing;
			// console.log(cellSize);
			// var cellSize = 10;

			var cellSize = Math.floor(Math.sqrt((width*height)/value));
			console.log(cellSize);
		    // calculate number of rows and columns
		    squaresColumn = Math.floor(width / (cellSize+cellSpacing));
		    squaresRow = Math.floor(height / (cellSize+cellSpacing));
		    console.log(squaresRow);
		    console.log(squaresColumn);
		    while(squaresColumn*squaresRow<value) {
		      cellSize-=1;
		      squaresColumn = Math.floor(width /  (cellSize+cellSpacing));
		      squaresRow = Math.floor(height /  (cellSize+cellSpacing));
		    }
		    console.log(squaresRow);
		    console.log(squaresColumn);


			// === First call === //

			databind(d3.range(value)); // ...then update the databind function
			
			var t = d3.timer(function(elapsed) {
				draw();
				if (elapsed > 500) t.stop();
			}); // start a timer that runs the draw function for 500 ms (this needs to be higher than the transition in the databind function)


			// === Bind and draw functions === //


			function databind(data) {

				// numberScale = d3.scaleSequential(d3[colours[colourId]]).domain(d3.extent(data, function(d) { return d; }));

				var join = custom.selectAll('custom.rect')
					.data(data);

				var enterSel = join.enter()
					.append('custom')
					.attr('class', 'rect')
					.attr('id', function(d, i) {
						console.log('r-' + Math.floor(i / squaresColumn) + 'c-' + Math.floor(i%squaresColumn));
						return 'r-' + Math.floor(i / squaresColumn) + 'c-' + Math.floor(i%squaresColumn);
			        })
				    .attr("x", function(i) {
				      	// return i * cellSize;
				        // var x0 = Math.floor(i / 1) % 100, x1 = Math.floor(i % 100);
				        // return groupSpacing * x0 + (cellSpacing + cellSize) * (x1 + x0 * 1);
				        return Math.floor(i%squaresColumn) * (cellSize+cellSpacing);
				    })
				    .attr("y", function(i) {
				    // return i * cellSize;
				    	var y0 = Math.floor(i / squaresColumn), y1 = Math.floor(i % 1 / 10);
				        return y0 + (cellSize) * (y1 + y0 * cellSpacing);
				        // return i/100 + cellSpacing;
				        // ((i%10) * (cellSize+cellSpacing));
				      })
					.attr('width', 0)
					.attr('height', 0);

				join
					.merge(enterSel)
					.transition()
					.attr('width', cellSize)
					.attr('height', cellSize)
					.attr('fillStyle', function(d) { return 'white'; })
					.attr('strokeStyle','green');

				var exitSel = join.exit()
					.transition()
					.attr('width', 0)
					.attr('height', 0)
					.remove();

			} // databind()


			// === Draw canvas === //

			function draw() {

				// clear canvas
				
				// context.fillStyle = '#fff';
				context.fillStyle = 'black'
				context.fillRect(0, 0, width, height);

				
				// draw each individual custom element with their properties
				
				var elements = custom.selectAll('custom.rect') // this is the same as the join variable, but used here to draw
				
				elements.each(function(d,i) {

					// for each virtual/custom element...

					var node = d3.select(this);
					context.fillStyle = node.attr('fillStyle');
					context.fillRect(node.attr('x'), node.attr('y'), node.attr('width'), node.attr('height'))

				});

			} // draw()



			// === Listeners/handlers === //


			// d3.select('#textinput').on('keydown', function() {

			// 	if (d3.event.keyCode === 13) {

			// 		d3.select('#alert').html('');

			// 		if (+this.value < 1 || +this.value > 10000) {

			// 			d3.select('#text-explain').classed('alert', true);

			// 			return;

			// 		} else {

			// 			d3.select('#text-explain').classed('alert', false);

			// 			value = +this.value;

			// 	    databind(d3.range(value), colourId);

			// 			var t = d3.timer(function(elapsed) {
			// 				draw();
			// 				if (elapsed > 500) t.stop();
			// 			}); // start a timer that runs the draw function for 500 ms (this needs to be higher than the transition in the databind function)

			// 		}
			  
			//   } // keyCode 13 === return
			  
			// }); // text input listener/handler


			// d3.select('select').on('change', function() {

			// 	log('fire');
				
			// 	log(this.value);

			// 	colourId = colours.indexOf(this.value);
			
			// 	log('colourId', colourId);
			// 	log('value', value);

			// 	databind(d3.range(value), colourId); // ...then update the databind function
				
			// 	var t = d3.timer(function(elapsed) {
			// 		draw();
			// 		if (elapsed > 500) t.stop();
			// 	}); // start a timer that runs the draw function for 500 ms (this needs to be higher than the transition in the databind function)

				
			// }); // select handler/listener

		}


	</script>

</body>
</html>