<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta charset='UTF-8'>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <title>Animate thousands of points with canvas and D3</title>
    <style>
    html, body {
      padding: 0;
      margin: 0;
    }
    canvas {
      /*cursor: pointer;*/
      background: white;
    }
    #container {
      width: 1000px;
      height: 500px;
      margin: 50px;

    }

    </style>
  </head>
  <body>

    <div id="container"></div>

    <script type="text/javascript">

      numPoints = 0;
      squaresRow = 0;
      squaresColumn =0;

      var gridLayout = function(points) {
        var gridDiv = document.getElementById("container");
        width = gridDiv.clientWidth;
        height = gridDiv.clientHeight;
        cellSize = Math.floor(Math.sqrt((width*height)/numPoints));
        
        if (cellSize < 5) { cellSpacing = 0.3; }
        else { cellSpacing = 1;}
        
        squaresColumn = Math.floor(width / (cellSize+cellSpacing));
        squaresRow = Math.floor(height / (cellSize+cellSpacing));
        while(squaresColumn*squaresRow<numPoints) {
          cellSize-=1;
          squaresColumn = Math.floor(width /  (cellSize+cellSpacing));
          squaresRow = Math.floor(height /  (cellSize+cellSpacing));
        }
        
        points.forEach((point, i) => {
          point.x = (cellSize+cellSpacing) * Math.floor(i / squaresRow);
          point.y = (cellSize+cellSpacing) * (i % squaresRow);
        });

        return points;
      }

      var draw = function(canvas) {
        const ctx = canvas.node().getContext('2d');
        ctx.save();

        // erase what is on the canvas currently
        ctx.clearRect(0, 0, width, height);

        // draw each point as a rectangle
        for (let i = 0; i < points.length; ++i) {
          const point = points[i];
          ctx.fillStyle = point.color;
          ctx.fillRect(point.x, point.y, cellSize, cellSize);
        }

        ctx.restore();
      }

      var changeSquareColor = function(points, id, color) {
        points[id].color = color;
      }

      var changeAreaColor = function(points, rowNum, columnNum, noOfSquares, color) {
        var id = columnNum*squaresRow+rowNum;
        for (var i = 0; i < noOfSquares; i++) {
          changeSquareColor(points,id+i,color);
        };
        draw(canvas);
      }

      var createProportionGraph = function (noOfSquares) {

        numPoints = noOfSquares;
        // generate the array of points with a unique ID and color
        points = d3.range(numPoints).map(index => ({
          id: index,
          color: "rgba(0, 0, 0, 0.3)"
        }));

        canvas = d3.select('#container')
          .append('canvas')

        gridLayout(points);
        canvas
          .attr('width', width)
          .attr('height', height);

        // changeAreaColor(points, 0, 10, 1333,"rgba(255, 0, 0, 0.4)");
        // changeAreaColor(points, 0, 10, 530,"rgba(255, 0, 0, 0.8)");
        draw(canvas);
      }

      createProportionGraph(2000);

    </script>

  </body>
</html>
