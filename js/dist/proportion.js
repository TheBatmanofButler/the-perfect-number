var propGraphParams={regions:[],propWidth:null,propHeight:null,squareOuterLength:null,columnLength:null,squares:[],canvases:[]},getSquareOuterLengthHelper=function(a,b,c){var d=Math.ceil,e=d(Math.sqrt(c*b/a));return Math.floor(e*a/b)*e<c?a/d(e*a/b):b/e},getSquareOuterLength=function(a,b,c){var d=getSquareOuterLengthHelper(b,a,c),e=getSquareOuterLengthHelper(a,b,c);return Math.floor(Math.max(d,e))},initPropGraph=function(a){allRegionsDrawn=!1,propGraphParams.regions=comparisonData[a]},updatePropGraphParams=function(){var a=$('.proportion-graph-wrapper').width(),b=$('.proportion-graph-wrapper').height(),c=propGraphParams.regions[0].numSquares;squareOuterLength=getSquareOuterLength(a,b,c),columnLength=Math.floor(b/squareOuterLength),squares=getGridSquares(c,squareOuterLength,columnLength),propGraphParams.propWidth=a,propGraphParams.propHeight=b,propGraphParams.numSquares=c,propGraphParams.squareOuterLength=squareOuterLength,propGraphParams.columnLength=columnLength,propGraphParams.squares=squares},getGridSquares=function(a,b,c){return d3.range(0,a).map(function(a){return{id:a,x:b*Math.floor(a/c),y:b*(a%c)}})},updatePropGraph=function(){var a=void 0===arguments[0]||arguments[0];if(0!=propGraphParams.regions.length)return updatePropGraphParams(),Promise.all([setAllRegionSquares(),getHoverMap(),createCanvases()]).then(function(){return drawAllCanvases(a)})},drawAllCanvases=function(a){var b=propGraphParams.regions,c=Promise.resolve(),d=function(b){addCanvas(b),a?0==b?c=c.then(function(){return Promise.all([showCanvas(b,1e3),drawRegion(b),showHoverText(b,2e3)])}):c=c.then(function(){return Promise.all([showCanvas(b,1e3)])}).then(function(){return Promise.all([showHoverText(b,2e3),drawRegion(b,a)])}):(showCanvas(b,0),drawRegion(b))};for(var e in b)d(e);return c=c.then(function(){var a=propGraphParams.regions[0].unit;return updateStoryText(2e3,'Each square is the equivalent of <b>$'+a+'</b>. Hover over each region to view more details.')}).then(function(){allRegionsDrawn=!0}),c},shuffleArray=function(b){for(var a,c,d,e,f=b.length;f;f--)e=Math.floor(Math.random()*f),a=[b[e],b[f-1]],b[f-1]=(c=a[Symbol.iterator](),(d=c.next()).done?void 0:d.value),b[e]=(d=c.next()).done?void 0:d.value,a;return b},createCanvases=function(){return new Promise(function(a){var b=propGraphParams.regions,c=propGraphParams.propWidth,d=propGraphParams.propHeight,e=propGraphParams.canvases=[],f=propGraphParams.regions[0].unit;updateStoryText(2e3,'Each square is the equivalent of <b>$'+f+'</b>. Hover over each region to view more details.');var g,h=function(a){var b=document.createElement('canvas');e.push(b),g=d3.select(b).attr('class',function(){return 1==a?'animated':'non-animated'}).attr('width',c).attr('height',d)};for(var i in b)h(i);g.call(addMouseEvent),d3.selectAll('canvas').transition().duration(500).style('opacity',0).remove().end(a)})},addMouseEvent=function(a){var b=Math.floor,c=propGraphParams.hoverMap,d=propGraphParams.regions,e=propGraphParams.numSquares;a.on('mousemove',function(){if(allRegionsDrawn){var a=d3.event.offsetX,c=d3.event.offsetY,d=b(a/squareOuterLength),e=b(c/squareOuterLength),f=d*columnLength+e;f in propGraphParams.hoverMap?showProperRegion(f):showAllRegions()}}).on('mouseout',function(){allRegionsDrawn&&showAllRegions()})},getHoverMap=function(){for(var a=propGraphParams.hoverMap={},b=propGraphParams.regions,c=b.length-1;-1<c;c--){var d=b[c],e=d.squares;for(var f in e){var g=e[f],h=g.id;a.hasOwnProperty(h)||(a[h]=c)}}},showHoverText=function(a,b){var c=propGraphParams.regions[a],d=c.text+' <b>$'+c.money+'</b>';return $('.dynamic-text').html()==d?Promise.resolve():updateStoryText(b,d)},showProperRegion=function(a){var b=propGraphParams.hoverMap,c=b[a];showHoverText(c,2e3),0==c?showOuterMainRegion():1==c?showInnerMainRegion():showComparisonRegion(c)},showAllRegions=function(){var a=propGraphParams.canvases,b=propGraphParams.regions[0].unit;updateStoryText(2e3,'Each square is the equivalent of <b>$'+b+'</b>. Hover over each region to view more details.');for(var c=0;c<a.length;c++)showCanvas(c)},showOuterMainRegion=function(){var a=propGraphParams.canvases;showCanvas(0);for(var b=1;b<a.length;b++)hideCanvas(b)},showInnerMainRegion=function(){var a=propGraphParams.canvases;showCanvas(1),makeCanvasOpaque(0,0.3);for(var b=2;b<a.length;b++)hideCanvas(b)},showComparisonRegion=function(a){for(var b=propGraphParams.canvases,c=0;c<b.length;c++)c==a?showCanvas(c):makeCanvasOpaque(c)},addCanvas=function(a){var b=propGraphParams.canvases,c=b[a];d3.select(c).style('opacity','0'),$('.proportion-graph-wrapper').append(c)},showCanvas=function(a){var b=void 0===arguments[1]?100:arguments[1];return new Promise(function(c){var d=propGraphParams.canvases,e=d[a];d3.select(e).transition().duration(b).style('opacity','1').end(c)})},hideCanvas=function(a){var b=propGraphParams.canvases,c=b[a];d3.select(c).transition().duration(100).style('opacity','0')},makeCanvasOpaque=function(a){var b=propGraphParams.canvases,c=b[a];d3.select(c).transition().duration(100).style('opacity','0.3')},changeOpacity=function(a,b){return a.replace(/[\d\.]+\)$/g,b+')')},drawRegion=function(a){var b=void 0!==arguments[1]&&arguments[1];return new Promise(function(c){var d,e,f,g=propGraphParams.canvases[a],h=propGraphParams.regions[a],j=propGraphParams.squareOuterLength,k=h.squares,l=h.numSquares,m=g.getContext('2d');d=Math.floor(j/9),0==d&&(d=0.5),e=j-d,b&&(k=shuffleArray(k),f=800/k.length),m.fillStyle=h.color;for(var n=function(a){var c=k[a];b?setTimeout(function(){m.fillRect(c.x,c.y,e,e)},f*a):m.fillRect(c.x,c.y,e,e)},o=0;o<l;++o)n(o);b?setTimeout(function(){c()},f*(l-1)):c()})},drawRegionByColumn=function(a){var b,c,d=propGraphParams.canvases[a],e=propGraphParams.regions[a],f=propGraphParams.squareOuterLength,g=e.squares,h=e.numSquares,k=d.getContext('2d'),j=propGraphParams.columnLength;b=Math.floor(f/9),0==b&&(b=0.5),c=f-b,k.fillStyle=e.color;for(var l=h,m=function(a){var b=0<l-j?j:l;setTimeout(function(){for(var d,e=0;e<b;++e)d=g[a+e],k.fillRect(d.x,d.y,c,c)},10*a),l-=j},n=0;n<h;n+=j)m(n)},setAllRegionSquares=function(){var a=1,b=propGraphParams.regions,c=propGraphParams.squareOuterLength,d=propGraphParams.columnLength,e=b[1].numSquares;'Tax breaks totaled '==b[0].text&&(e=0);for(var f=0;f<b.length;f++){var g=b[f],h=g.numSquares;2>f?a=setSubregionSquares(g,h,0,1):('Tax breaks totaled '==b[0].text&&2==f&&(a=1),a=setSubregionSquares(g,h,e,a)),1<f&&(e+=h)}},setSubregionSquares=function(a,b,c,d){a.squares=[];for(var e,f=propGraphParams.squares,g=propGraphParams.columnLength,h=a.squares,i=0;i<b;i++)if(e=c+i,1==d){var j=getSquareObject(e);h.push(j),0==(e+1)%g&&(d=2)}else{var k=(Math.floor(e/g)+1)*g-e%g-1,l=getSquareObject(k);h.push(l),0==(e+1)%g&&(d=1)}return d},getSquareObject=function(a){var b=propGraphParams.squareOuterLength,c=propGraphParams.columnLength;return{id:a,x:b*Math.floor(a/c),y:b*(a%c)}};